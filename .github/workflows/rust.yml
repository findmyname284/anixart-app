name: Rust CI
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
jobs:
  linux-build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v3
      # Установка Rust
      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - run: rustup default stable
      # Установка зависимостей для Linux
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-4-dev \
            libgirepository1.0-dev \
            libcairo2-dev \
            libpango1.0-dev \
            build-essential \
            libadwaita-1-dev \
            pkg-config \
            libssl-dev
      # Сборка проекта
      - name: Build project
        run: cargo build --release
      # Загрузка артефакта
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: anixart-app-linux
          path: target/release/anixart-app
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install GTK (MSYS2)
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: mingw-w64-x86_64-gtk4 mingw-w64-x86_64-rust
      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          target: x86_64-pc-windows-gnu
      - name: Build
        shell: msys2 {0}
        run: cargo build --release
      - name: Fix DLL dependencies
        run: |
          cp "C:/msys64/mingw64/bin/"*.dll target/release/
          cp "C:/msys64/mingw64/bin/gspawn-win64-helper.exe" target/release/
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-app
          path: target/release/anixart-app.exe
